{% extends 'main/layout.html' %}
{% load static %}

{% block title %}
<title>Customer Page</title>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white my-12 rounded-2xl shadow-lg w-full p-8 overflow-y-auto" style="height: 88vh;">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">Sun Control Retractable Shades</h1>
        <span id="unicode" class="text-gray-500">{{ customer.unique_code }}</span>
    </div>
    <div class="border-b mb-4">
        <nav class="flex space-x-4">
            <a href="#info" class="py-2 px-4 text-blue-500 border-b-2 border-blue-500" onclick="switchTab(event, 'info')">INFO</a>
            <a href="#gallery" class="py-2 px-4 text-gray-500" onclick="switchTab(event, 'gallery')">GALLERY</a>
            <a href="#timeline" class="py-2 px-4 text-gray-500" onclick="switchTab(event, 'timeline')">TIMELINE</a>
            <a href="#orders" class="py-2 px-4 text-gray-500" onclick="switchTab(event, 'orders')">ORDERS</a>
        </nav>
    </div>
    <div id="info" class="tab-content flex flex-col justify-between p-4">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <h2 class="text-lg font-bold">Primary Contact</h2>
                <p class="text-md font-regular text-gray-700">{{ customer.primary_contact }}</p>
                <h2 class="text-lg font-bold mt-8">Phone</h2>
                <p class="text-md font-regular text-gray-700">Main: {{ customer.main }}</p>
                <p class="text-md font-regular text-gray-700">Mobile: {{ customer.mobile }}</p>
                <h2 class="text-lg font-bold mt-8">Email</h2>
                <p class="text-md font-regular text-gray-700">Main: {{ customer.email }}</p>
                <p class="text-md font-regular text-gray-700">CC:</p>
                <h2 class="text-lg font-bold mt-8">Website</h2>
                <a href="{{ customer.website }}" class="text-md font-regular text-blue-500 hover:text-blue-600">{{ customer.website }}</a>
            </div>
            <div>
                <h2 class="text-lg font-bold">Account Notes</h2>
                <p class="text-md font-regular text-gray-700">{{ customer.account_notes }}</p>
                <h2 class="text-lg font-bold mt-8">Default Order Notes</h2>
                <p class="text-md font-regular text-gray-700">{{ customer.default_order_notes }}</p>
            </div>
        </div>
        <div>
           <a href="{% url 'schedule' customer.unique_code %}"><button class="mt-4 py-2 px-4 bg-blue-500 text-white rounded-lg">SCHEDULE A VISIT</button></a> 
        </div>
    </div>
    <div id="gallery" class="tab-content hidden justify-between p-4">
        <div class="w-72 h-8 flex flex-row items-center justify-center gap-3 relative right-0 float-right">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#888" class="w-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
            <input type="text" placeholder="Gallery Search" class="w-full h-8 p-2 border border-gray-400 rounded">
        </div>
        <div>
            {% for date, images in grouped_images.items %}
                <div class="my-4">
                    <h2 class="text-lg font-bold mb-6">{{ date }}</h2>
                    <div class="gallery flex flex-wrap gap-4 w-full">
                        {% for image in images %}
                            <div class="image p-2 bg-gray-200">
                                <img class="h-24 object-contain" src="{{ image.signed_url }}" alt="Image">
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <div id="timeline" class="tab-content hidden justify-between p-4">
        <div class="w-full flex items-center justify-end gap-6">
            
            <button class="h-8 w-fit px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-md" id="newPostBtn">NEW POST</button>
            <div class="flex flex-row items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#888" class="w-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>
                <input type="text" placeholder="Gallery Search" class=" h-8 p-2 border border-gray-400 rounded">
            </div>
        </div>
        <div class="flex flex-col-reverse  mt-8 gap-8 overflow-y-auto h-96 border-2 p-6 rounded-2xl bg-gray-50 w-full">
            {% if not timelines %}
            <div class="flex w-full items-center justify-center h-full">
                <img class="h-36 opacity-20" src="{% static 'images/empty.png' %}">
            </div>
            {% endif %}
            {% for event in timelines %}
            <div class="flex w-full gap-8 items-center justify-center">
                <div class="w-12">
                    <img class="w-12 object-cover rounded-full" src="https://static.vecteezy.com/system/resources/thumbnails/009/292/244/small/default-avatar-icon-of-social-media-user-vector.jpg" />
                </div>
                <div class="w-full border-2 border-gray-200 bg-white rounded-2xl p-4">
                    <p>{{event.comment}}</p>
                    <div class="h-2 flex  justify-between text-sm text-gray-500 my-6">
                        <p>{{ event.user.username }}</p>
                        <div class="flex gap-4">
                            {% if event.type in "ti" %}
                            <p class="text-yellow-600 semi-bold">TECHNICAL ISSUE</p>
                            {% elif event.type in "of" %}
                            <p class="text-green-700 semi-bold">ORDER FINALIZED</p>
                            {% elif event.type in "rma" %}
                            <p class="text-red-700 semi-bold">RMA</p>
                            {% else %}
                            <p class="text-gray-600 semi-bold">OTHER</p>
                            {% endif %}
                            <p>{{ event.timestamp }}</p>

                            <form method="post" action="{% url 'delete_event' event.id %}">
                                {% csrf_token %}
                                <button type="submit" class="text-red-600 hover:text-red-700 cursor-pointer font-semibold">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div id="orders" class="tab-content hidden justify-between p-4">
        <div class="w-72 text-right h-8 flex flex-row items-center justify-end gap-3 relative right-0 float-right">
            <a href="{% url 'order' unique_code=customer.unique_code %}" class="h-8 w-fit px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-md flex items-center justify-center">NEW ORDER</a>
        </div>
        <div class="flex gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#888" class="w-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
            <input type="text" placeholder="Search Job" class="h-8 p-2 border border-gray-400 rounded">
        </div>
        <div class="container">
            <div class="sidebar border-r-2 border-gray-200 p-4">
                <ul id="folders-list" data-path="">
                    {% for folder in folders %}
                    <li class="folder float-left" data-path="{{ folder.path }}">
                        {{ folder.name }}
                        {% if folder.subfolders %}
                        <ul class="subfolder hidden">
                            {% for subfolder in folder.subfolders %}
                            <li class="subfolder-item folder" data-path="{{ subfolder.path }}">{{ subfolder.name }}</li>
                            {% endfor %}
                            {% for file in folder.files %}
                            {% if file.name|slice:"-4:" == ".pdf" %}
                            <img src="https://www.svgrepo.com/download/144578/pdf.svg" class="h-3">
                            {% endif %}
                            <li class="file">{{ file.name }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="main-content p-4">
                <ul id="files-list"></ul>
            </div>
        </div>
    </div>
</div>

<div id="timeline" class="tab-content hidden justify-between p-4">
    <div class="w-full flex items-center justify-end gap-6">
        
        <button id="newPostBtn" class="h-8 w-fit px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-md">NEW POST</button>
        <div class="flex flex-row items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#888" class="w-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
            <input type="text" placeholder="Timeline Search" class=" h-8 p-2 border border-gray-400 rounded">
        </div>
    </div>
</div>

<!-- The Modal -->
<div id="newPostModal" class="modal hidden fixed left-0 top-0 w-full h-full bg-gray-900 bg-opacity-50 flex justify-center items-center">
    <div class="modal-content bg-white p-4 rounded-md shadow-lg w-1/3">
        <span id="closeModal" class="close text-red-500 cursor-pointer float-right">x</span>
        <h2 class="text-lg font-bold mb-4">New Timeline Post</h2>
        <form id="newPostForm" method="POST" action="{% url 'timeline_create' unique_code=customer.unique_code %}">
            {% csrf_token %}
            <div class="mb-4">
                <label for="type" class="block text-gray-700">Type</label>
                <select name="type" id="type" class="border border-gray-400 rounded w-full p-2">
                    <option value="ti">Technical Issues</option>
                    <option value="of">Order Finalized</option>
                    <option value="rma">RMA</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="comment" class="block text-gray-700">Comment</label>
                <textarea name="comment" id="comment" class="border border-gray-400 rounded w-full p-2"></textarea>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-md px-4 py-2">Submit</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    function switchTab(event, tabId) {
        event.preventDefault();

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        document.querySelectorAll('nav a').forEach(tab => {
            tab.classList.remove('border-blue-500', 'text-blue-500', 'border-b-2');
            tab.classList.add('text-gray-500');
        });

        document.getElementById(tabId).classList.remove('hidden');

        // Add active class to the selected tab
        event.currentTarget.classList.add('border-blue-500', 'text-blue-500', 'border-b-2');
        event.currentTarget.classList.remove('text-gray-500');

        // Save the selected tab in local storage
        localStorage.setItem('selectedTab', tabId);
    }

    // Check for the saved tab in local storage
    window.onload = function() {
        const savedTab = localStorage.getItem('selectedTab') || 'info'; // Default to 'info' tab if none saved

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        document.querySelectorAll('nav a').forEach(tab => {
            tab.classList.remove('border-blue-500', 'text-blue-500', 'border-b-2');
            tab.classList.add('text-gray-500');
        });

        document.getElementById(savedTab).classList.remove('hidden');
        document.querySelector(`nav a[href="#${savedTab}"]`).classList.add('border-blue-500', 'text-blue-500', 'border-b-2');
        document.querySelector(`nav a[href="#${savedTab}"]`).classList.remove('text-gray-500');
    }

    document.getElementById('newPostBtn').onclick = function() {
        document.getElementById('newPostModal').classList.remove('hidden');
    }

    document.getElementById('closeModal').onclick = function() {
        document.getElementById('newPostModal').classList.add('hidden');
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('newPostModal')) {
            document.getElementById('newPostModal').classList.add('hidden');
        }
    }

    function refresh(){
        window.location.reload("Refresh")
      }
</script>

<style>
.container {
        display: flex;
        flex-direction: row;
        gap: 8px;
        margin-top: 8px;
        overflow-y: auto;
        height: 24rem; /* h-96 */
        border: 2px solid;
        padding: 24px; /* p-6 */
        border-color: #eee;
        border-radius: 1rem; /* rounded-2xl */
        background-color: #f9fafb; /* bg-gray-50 */
        width: 100%;
    }

    .sidebar {
        flex: 1 1 25%; /* Takes one-fourth of the space */
        overflow-y: auto;
    }

    .main-content {
        flex: 1 1 75%; /* Takes the remaining space */
        overflow-y: auto;
    }
    li{
        display: flex;
        flex-direction: column;
    }

    ul {
        list-style-type: none;
        padding-left: 0px;
        margin-left: 0; /* Ensure no extra indentation on root level */
    }

    .folder {
        cursor: pointer;
        margin-bottom: 8px;
    }

    li ul {
        margin-left: 10px;
    }
    ul ul {
        margin-left: 10px;
    }

    .file {
        cursor: pointer;
        margin-left: 20px; /* Indent files under subfolders */
        margin-bottom: 8px;

    }

    .subfolder {
        margin-left: 20px; /* Indent subfolders */
        list-style-type: none; /* Remove bullets for subfolders */
    }

    .subfolder-item {
        margin-left: 20px; /* Indent subfolder items */
    }

    .hidden {
        display: none;
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
<script>
   $(document).ready(function () {
    function loadFolderContents(folderPath, targetElement, isFolderClick = false) {
        $.ajax({
            url: '/storage/browser/contents/',
            data: {
                'folder_path': folderPath
            },
            dataType: 'json',
            success: function (data) {
                updateFolderView(data, targetElement, folderPath, isFolderClick);
            }
        });
    }

    function updateFolderView(data, targetElement, parentPath, isFolderClick) {
    if (isFolderClick) {
        $('#files-list').empty();
    }

    // Clear target element only if it's the main folders list
    if (targetElement.attr('id') === 'folders-list' || isFolderClick) {
        if (!isFolderClick) {
            $(targetElement).empty();
        }

        data.folders.forEach(function (folder) {
            var fullPath = parentPath + '/' + folder;
            if (!$('li[data-path="' + fullPath + '"]').length) {
                var folderElement = $(
                    '<li class="folder flex gap-2" data-path="' + fullPath + '"><span class="flex gap-2">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#777777" class="h-6">' +
                    '<path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z" />' +
                    '</svg>' +
                    folder +
                    '</span></li>'
                );
                var sublist = $('<ul class="hidden"></ul>');  // Initially hidden
                folderElement.append(sublist);
                folderElement.click(function (e) {
                    e.stopPropagation();
                    if (sublist.hasClass('hidden')) {
                        sublist.removeClass('hidden');
                        loadFolderContents(fullPath, sublist, true);
                    } else {
                        sublist.addClass('hidden');
                        sublist.empty();  // Clear sublist when collapsing
                        $('#files-list').empty(); // Clear files list when collapsing
                    }
                });
                $(targetElement).append(folderElement);
            }
        });
    }

    if (isFolderClick && targetElement.attr('id') !== 'folders-list') {
        data.files.forEach(function (file) {
            if (file[0].endsWith('.pdf')) {
                var fileElement = $(`<a href="${file[1]}" target="_blank"><li class="file flex flex-row gap-3 hover:bg-gray-200 cursor-pointer"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/1667px-PDF_file_icon.svg.png" class="h-6">${file[0]}</li>` );
            }else if (file[0].endsWith('.jpg') ||file[0].endsWith('.png')||file[0].endsWith('.jpeg') ) {
                var fileElement =  $('<a href="'+file[1]+'" target="_blank"><li class="file flex flex-row gap-3">' + ' <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR2HY7nWjTlI-QqOx2lK3oPQc2PuikkOO3g-MTRa68WUnpzl4ss9CsRMsjt5pLCbjgzxlk&usqp=CAU" class="h-6">'+ file[0]+ '</li></a>' );
            } else {
                var fileElement = $('<a href="'+file[1]+'" target="_blank"><li class="file flex flex-row gap-3">' + ' <img src="https://uxwing.com/wp-content/themes/uxwing/download/file-and-folder-type/page-file-icon.png" class="h-6">'+ file[0]+ '</li></a>' );
            }
            $('#files-list').append(fileElement);
        });
    }
}

    // Initial load
    loadFolderContents('{{ base_prefix }}', $('#folders-list'));
});


</script>
{% endblock %}
